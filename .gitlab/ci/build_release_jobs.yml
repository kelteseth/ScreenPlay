steam_linux:
  stage: release_build
  extends:
    - .base_linux_build
  script:
    - python3 Tools/build.py --type=release --steam --deploy-version --use-aqt --installer
  rules:
    - if: "$CI_COMMIT_TAG"
  artifacts:
    paths:
      - build-x64-linux-release/bin

steam_windows:
  stage: release_build
  extends:
    - .base_windows_build
  script:
    - python Tools/build.py --type=release --steam --use-aqt --deploy-version
  rules:
    - if: "$CI_COMMIT_TAG"
  artifacts:
    paths:
      - build-x64-windows-release/
      - build-x64-windows-release/ScreenPlay-$CI_COMMIT_TAG-x64-windows-release.zip

steam_osx:
  stage: release_build
  extends:
    - .base_osx_build
  script:
    - python3 Tools/build.py --type=release --steam --use-aqt --deploy-version --sign_osx
  rules:
    - if: "$CI_COMMIT_TAG"
  artifacts:
    paths:
      - build-64-osx-universal-release/
      - build-64-osx-universal-release/bin/ScreenPlay.app

release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - |
      is_pre_release=false
      if [[ "$CI_COMMIT_TAG" =~ -dev[0-9]+$ || "$CI_COMMIT_TAG" =~ -beta[0-9]+$ || "$CI_COMMIT_TAG" =~ -rc[0-9]+$ ]]; then
        is_pre_release=true
      fi
      if $is_pre_release; then
        release_name="ScreenPlay Pre-release $CI_COMMIT_TAG"
        description="üéâ A Wild ScreenPlay Pre-release Appeared!"
        pre_release_flag="--pre-release"
      else
        release_name="ScreenPlay Release $CI_COMMIT_TAG"
        description="üéâ A Wild ScreenPlay Release Appeared!"
        pre_release_flag=""
      fi
      release-cli create --name "$release_name" \
                         --description "$description" \
                         --tag-name $CI_COMMIT_TAG \
                         --ref $CI_COMMIT_REF_NAME \
                         $pre_release_flag \
                         --assets-link '[{"name":"üêß Linux x64 build","url":"$CI_PIPELINE_URL/artifacts/file/build-x64-linux-release/bin"},{"name":"ü™ü Windows x64 build","url":"$CI_PIPELINE_URL/artifacts/file/build-x64-windows-release/ScreenPlay-$CI_COMMIT_TAG-x64-windows-release.zip"},{"name":"üçè OSX universal build","url":"$CI_PIPELINE_URL/artifacts/file/build-64-osx-universal-release/bin/ScreenPlay.app"}]'
  rules:
    - if: "$CI_COMMIT_TAG"
